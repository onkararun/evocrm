/* global Color, jQuery */
!function(i,r){function e(){var r,e,t="backgroundImage";p?c="filter":(r=i('<div id="iris-gradtest" />'),e="linear-gradient(top,#fff,#000)",i.each(d,function(i,o){return r.css(t,o+e),r.css(t).match("gradient")?(c=i,!1):void 0}),c===!1&&(r.css("background","-webkit-gradient(linear,0% 0%,0% 100%,from(#fff),to(#000))"),r.css(t).match("gradient")&&(c="webkit")),r.remove())}function t(r,e){return r="top"===r?"top":"left",e=i.isArray(e)?e:Array.prototype.slice.call(arguments,1),"webkit"===c?s(r,e):d[c]+"linear-gradient("+r+", "+e.join(", ")+")"}function o(r,e){var t,o,s,n,l,p,c,d,h;r="top"===r?"top":"left",e=i.isArray(e)?e:Array.prototype.slice.call(arguments,1),t="top"===r?0:1,o=i(this),s=e.length-1,n="filter",l=1===t?"left":"top",p=1===t?"right":"bottom",c=1===t?"height":"width",d='<div class="iris-ie-gradient-shim" style="position:absolute;'+c+":100%;"+l+":%start%;"+p+":%end%;"+n+':%filter%;" data-color:"%color%"></div>',h="","static"===o.css("position")&&o.css({position:"relative"}),e=a(e),i.each(e,function(i,r){var o,a,n;return i===s?!1:(o=e[i+1],void(r.stop!==o.stop&&(a=100-parseFloat(o.stop)+"%",r.octoHex=new Color(r.color).toIEOctoHex(),o.octoHex=new Color(o.color).toIEOctoHex(),n="progid:DXImageTransform.Microsoft.Gradient(GradientType="+t+", StartColorStr='"+r.octoHex+"', EndColorStr='"+o.octoHex+"')",h+=d.replace("%start%",r.stop).replace("%end%",a).replace("%filter%",n))))}),o.find(".iris-ie-gradient-shim").remove(),i(h).prependTo(o)}function s(r,e){var t=[];return r="top"===r?"0% 0%,0% 100%,":"0% 100%,100% 100%,",e=a(e),i.each(e,function(i,r){t.push("color-stop("+parseFloat(r.stop)/100+", "+r.color+")")}),"-webkit-gradient(linear,"+r+t.join(",")+")"}function a(r){var e=[],t=[],o=[],s=r.length-1;return i.each(r,function(i,r){var o=r,s=!1,a=r.match(/1?[0-9]{1,2}%$/);a&&(o=r.replace(/\s?1?[0-9]{1,2}%$/,""),s=a.shift()),e.push(o),t.push(s)}),t[0]===!1&&(t[0]="0%"),t[s]===!1&&(t[s]="100%"),t=n(t),i.each(t,function(i){o[i]={color:e[i],stop:t[i]}}),o}function n(r){var e,t,o,s,a=0,l=r.length-1,p=0,c=!1;if(r.length<=2||i.inArray(!1,r)<0)return r;for(;p<r.length-1;)c||r[p]!==!1?c&&r[p]!==!1&&(l=p,p=r.length):(a=p-1,c=!0),p++;for(t=l-a,s=parseInt(r[a].replace("%"),10),e=(parseFloat(r[l].replace("%"))-s)/t,p=a+1,o=1;l>p;)r[p]=s+o*e+"%",o++,p++;return n(r)}var l,p,c,d,h,u,f,g,v;return l='<div class="iris-picker"><div class="iris-picker-inner"><div class="iris-square"><a class="iris-square-value" href="#"><span class="iris-square-handle ui-slider-handle"></span></a><div class="iris-square-inner iris-square-horiz"></div><div class="iris-square-inner iris-square-vert"></div></div><div class="iris-slider iris-strip"><div class="iris-slider-offset"></div></div></div></div>',h='.iris-picker{display:block;position:relative}.iris-picker,.iris-picker *{-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input+.iris-picker{margin-top:4px}.iris-error{background-color:#ffafaf}.iris-border{border-radius:3px;border:1px solid #aaa;width:200px;background-color:#fff}.iris-picker-inner{position:absolute;top:0;right:0;left:0;bottom:0}.iris-border .iris-picker-inner{top:10px;right:10px;left:10px;bottom:10px}.iris-picker .iris-square-inner{position:absolute;left:0;right:0;top:0;bottom:0}.iris-picker .iris-square,.iris-picker .iris-slider,.iris-picker .iris-square-inner,.iris-picker .iris-palette{border-radius:3px;box-shadow:inset 0 0 5px rgba(0,0,0,.4);height:100%;width:12.5%;float:left;margin-right:5%}.iris-picker .iris-square{width:76%;margin-right:10%;position:relative}.iris-picker .iris-square-inner{width:auto;margin:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-square-inner,.iris-ie-9 .iris-palette{box-shadow:none;border-radius:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-palette{outline:1px solid rgba(0,0,0,.1)}.iris-ie-lt9 .iris-square,.iris-ie-lt9 .iris-slider,.iris-ie-lt9 .iris-square-inner,.iris-ie-lt9 .iris-palette{outline:1px solid #aaa}.iris-ie-lt9 .iris-square .ui-slider-handle{outline:1px solid #aaa;background-color:#fff;-ms-filter:"alpha(Opacity=30)"}.iris-ie-lt9 .iris-square .iris-square-handle{background:0;border:3px solid #fff;-ms-filter:"alpha(Opacity=50)"}.iris-picker .iris-strip{margin-right:0;position:relative}.iris-picker .iris-strip .ui-slider-handle{position:absolute;background:0;margin:0;right:-3px;left:-3px;border:4px solid #aaa;border-width:4px 3px;width:auto;height:6px;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.2);opacity:.9;z-index:5;cursor:ns-resize}.iris-strip .ui-slider-handle:before{content:" ";position:absolute;left:-2px;right:-2px;top:-3px;bottom:-3px;border:2px solid #fff;border-radius:3px}.iris-picker .iris-slider-offset{position:absolute;top:11px;left:0;right:0;bottom:-3px;width:auto;height:auto;background:transparent;border:0;border-radius:0}.iris-picker .iris-square-handle{background:transparent;border:5px solid #aaa;border-radius:50%;border-color:rgba(128,128,128,.5);box-shadow:none;width:12px;height:12px;position:absolute;left:-10px;top:-10px;cursor:move;opacity:1;z-index:10}.iris-picker .ui-state-focus .iris-square-handle{opacity:.8}.iris-picker .iris-square-handle:hover{border-color:#999}.iris-picker .iris-square-value:focus .iris-square-handle{box-shadow:0 0 2px rgba(0,0,0,.75);opacity:.8}.iris-picker .iris-square-handle:hover::after{border-color:#fff}.iris-picker .iris-square-handle::after{position:absolute;bottom:-4px;right:-4px;left:-4px;top:-4px;border:3px solid #f9f9f9;border-color:rgba(255,255,255,.8);border-radius:50%;content:" "}.iris-picker .iris-square-value{width:8px;height:8px;position:absolute}.iris-ie-lt9 .iris-square-value,.iris-mozilla .iris-square-value{width:1px;height:1px}.iris-palette-container{position:absolute;bottom:0;left:0;margin:0;padding:0}.iris-border .iris-palette-container{left:10px;bottom:10px}.iris-picker .iris-palette{margin:0;cursor:pointer}',f=navigator.userAgent.toLowerCase(),g="Microsoft Internet Explorer"===navigator.appName,v=g?parseFloat(f.match(/msie ([0-9]{1,}[\.0-9]{0,})/)[1]):0,p=g&&10>v,c=!1,d=["-moz-","-webkit-","-o-","-ms-"],p&&7>=v?(i.fn.iris=i.noop,void(i.support.iris=!1)):(i.support.iris=!0,i.fn.gradient=function(){var r=arguments;return this.each(function(){p?o.apply(this,r):i(this).css("backgroundImage",t.apply(this,r))})},i.fn.raninbowGradient=function(r,e){var t,o,s,a;for(r=r||"top",t=i.extend({},{s:100,l:50},e),o="hsl(%h%,"+t.s+"%,"+t.l+"%)",s=0,a=[];360>=s;)a.push(o.replace("%h%",s)),s+=30;return this.each(function(){i(this).gradient(r,a)})},u={options:{color:!1,mode:"hsl",controls:{horiz:"s",vert:"l",strip:"h"},hide:!0,border:!0,target:!1,width:200,palettes:!1},_color:"",_palettes:["#000","#fff","#d33","#d93","#ee2","#81d742","#1e73be","#8224e3"],_inited:!1,_defaultHSLControls:{horiz:"s",vert:"l",strip:"h"},_defaultHSVControls:{horiz:"h",vert:"v",strip:"s"},_scale:{h:360,s:100,l:100,v:100},_create:function(){var r=this,t=r.element,o=r.options.color||t.val();c===!1&&e(),t.is("input")?(r.picker=r.options.target?i(l).appendTo(r.options.target):i(l).insertAfter(t),r._addInputListeners(t)):(t.append(l),r.picker=t.find(".iris-picker")),g?9===v?r.picker.addClass("iris-ie-9"):8>=v&&r.picker.addClass("iris-ie-lt9"):f.indexOf("compatible")<0&&f.indexOf("khtml")<0&&f.match(/mozilla/)&&r.picker.addClass("iris-mozilla"),r.options.palettes&&r._addPalettes(),r._color=new Color(o).setHSpace(r.options.mode),r.options.color=r._color.toString(),r.controls={square:r.picker.find(".iris-square"),squareDrag:r.picker.find(".iris-square-value"),horiz:r.picker.find(".iris-square-horiz"),vert:r.picker.find(".iris-square-vert"),strip:r.picker.find(".iris-strip"),stripSlider:r.picker.find(".iris-strip .iris-slider-offset")},"hsv"===r.options.mode&&r._has("l",r.options.controls)?r.options.controls=r._defaultHSVControls:"hsl"===r.options.mode&&r._has("v",r.options.controls)&&(r.options.controls=r._defaultHSLControls),r.hue=r._color.h(),r.options.hide&&r.picker.hide(),r.options.border&&r.picker.addClass("iris-border"),r._initControls(),r.active="external",r._dimensions(),r._change()},_has:function(r,e){var t=!1;return i.each(e,function(i,e){return r===e?(t=!0,!1):void 0}),t},_addPalettes:function(){var r=i('<div class="iris-palette-container" />'),e=i('<a class="iris-palette" tabindex="0" />'),t=i.isArray(this.options.palettes)?this.options.palettes:this._palettes;this.picker.find(".iris-palette-container").length&&(r=this.picker.find(".iris-palette-container").detach().html("")),i.each(t,function(i,t){e.clone().data("color",t).css("backgroundColor",t).appendTo(r).height(10).width(10)}),this.picker.append(r)},_paint:function(){var i=this;i._paintDimension("top","strip"),i._paintDimension("top","vert"),i._paintDimension("left","horiz")},_paintDimension:function(i,r){var e,t=this,o=t._color,s=t.options.mode,a=t._getHSpaceColor(),n=t.controls[r],l=t.options.controls;if(r!==t.active&&("square"!==t.active||"strip"===r))switch(l[r]){case"h":if("hsv"===s){switch(a=o.clone(),r){case"horiz":a[l.vert](100);break;case"vert":a[l.horiz](100);break;case"strip":a.setHSpace("hsl")}e=a.toHsl()}else e="strip"===r?{s:a.s,l:a.l}:{s:100,l:a.l};n.raninbowGradient(i,e);break;case"s":"hsv"===s?"vert"===r?e=[o.clone().a(0).s(0).toCSS("rgba"),o.clone().a(1).s(0).toCSS("rgba")]:"strip"===r?e=[o.clone().s(100).toCSS("hsl"),o.clone().s(0).toCSS("hsl")]:"horiz"===r&&(e=["#fff","hsl("+a.h+",100%,50%)"]):e="vert"===r&&"h"===t.options.controls.horiz?["hsla(0, 0%, "+a.l+"%, 0)","hsla(0, 0%, "+a.l+"%, 1)"]:["hsl("+a.h+",0%,50%)","hsl("+a.h+",100%,50%)"],n.gradient(i,e);break;case"l":e="strip"===r?["hsl("+a.h+",100%,100%)","hsl("+a.h+", "+a.s+"%,50%)","hsl("+a.h+",100%,0%)"]:["#fff","rgba(255,255,255,0) 50%","rgba(0,0,0,0) 50%","rgba(0,0,0,1)"],n.gradient(i,e);break;case"v":e="strip"===r?[o.clone().v(100).toCSS(),o.clone().v(0).toCSS()]:["rgba(0,0,0,0)","#000"],n.gradient(i,e)}},_getHSpaceColor:function(){return"hsv"===this.options.mode?this._color.toHsv():this._color.toHsl()},_dimensions:function(r){var e,t,o,s,a=this,n=a.options,l=a.controls,p=l.square,c=a.picker.find(".iris-strip"),d="77.5%",h="12%",u=20,f=n.border?n.width-u:n.width,g=i.isArray(n.palettes)?n.palettes.length:a._palettes.length;return r&&(p.css("width",""),c.css("width",""),a.picker.css({width:"",height:""})),d=f*(parseFloat(d)/100),h=f*(parseFloat(h)/100),e=n.border?d+u:d,p.width(d).height(d),c.height(d).width(h),a.picker.css({width:n.width,height:e}),n.palettes?(t=2*d/100,s=d-(g-1)*t,o=s/g,a.picker.find(".iris-palette").each(function(r){var e=0===r?0:t;i(this).css({width:o,height:o,marginLeft:e})}),a.picker.css("paddingBottom",o+t),void c.height(o+t+d)):a.picker.css("paddingBottom","")},_addInputListeners:function(i){var r=this,e=100,t=function(e){var t=new Color(i.val()),o=i.val().replace(/^#/,"");i.removeClass("iris-error"),t.error?""!==o&&i.addClass("iris-error"):t.toString()!==r._color.toString()&&("keyup"===e.type&&o.match(/^[0-9a-fA-F]{3}$/)||r._setOption("color",t.toString()))};i.on("change",t).on("keyup",r._debounce(t,e)),r.options.hide&&i.one("focus",function(){r.show()})},_initControls:function(){var r=this,e=r.controls,t=e.square,o=r.options.controls,s=r._scale[o.strip];e.stripSlider.slider({orientation:"vertical",max:s,slide:function(i,e){r.active="strip","h"===o.strip&&(e.value=s-e.value),r._color[o.strip](e.value),r._change.apply(r,arguments)}}),e.squareDrag.draggable({containment:"parent",zIndex:1e3,cursor:"move",drag:function(i,e){r._squareDrag(i,e)},start:function(){t.addClass("iris-dragging"),i(this).addClass("ui-state-focus")},stop:function(){t.removeClass("iris-dragging"),i(this).removeClass("ui-state-focus")}}).on("mousedown mouseup",function(e){var t="ui-state-focus";e.preventDefault(),"mousedown"===e.type?(r.picker.find("."+t).removeClass(t).blur(),i(this).addClass(t).focus()):i(this).removeClass(t)}).on("keydown",function(i){var t=e.square,o=e.squareDrag,s=o.position(),a=r.options.width/100;switch(i.altKey&&(a*=10),i.keyCode){case 37:s.left-=a;break;case 38:s.top-=a;break;case 39:s.left+=a;break;case 40:s.top+=a;break;default:return!0}s.left=Math.max(0,Math.min(s.left,t.width())),s.top=Math.max(0,Math.min(s.top,t.height())),o.css(s),r._squareDrag(i,{position:s}),i.preventDefault()}),t.mousedown(function(e){var t,o;1===e.which&&i(e.target).is("div")&&(t=r.controls.square.offset(),o={top:e.pageY-t.top,left:e.pageX-t.left},e.preventDefault(),r._squareDrag(e,{position:o}),e.target=r.controls.squareDrag.get(0),r.controls.squareDrag.css(o).trigger(e))}),r.options.palettes&&r._paletteListeners()},_paletteListeners:function(){var r=this;r.picker.find(".iris-palette-container").on("click.palette",".iris-palette",function(){r._color.fromCSS(i(this).data("color")),r.active="external",r._change()}).on("keydown.palette",".iris-palette",function(r){return 13!==r.keyCode&&32!==r.keyCode?!0:(r.stopPropagation(),void i(this).click())})},_squareDrag:function(i,r){var e=this,t=e.options.controls,o=e._squareDimensions(),s=Math.round((o.h-r.position.top)/o.h*e._scale[t.vert]),a=e._scale[t.horiz]-Math.round((o.w-r.position.left)/o.w*e._scale[t.horiz]);e._color[t.horiz](a)[t.vert](s),e.active="square",e._change.apply(e,arguments)},_setOption:function(r,e){var t,o,s,a=this,n=a.options[r],l=!1;switch(a.options[r]=e,r){case"color":e=""+e,t=e.replace(/^#/,""),o=new Color(e).setHSpace(a.options.mode),o.error?a.options[r]=n:(a._color=o,a.options.color=a.options[r]=a._color.toString(),a.active="external",a._change());break;case"palettes":l=!0,e?a._addPalettes():a.picker.find(".iris-palette-container").remove(),n||a._paletteListeners();break;case"width":l=!0;break;case"border":l=!0,s=e?"addClass":"removeClass",a.picker[s]("iris-border");break;case"mode":case"controls":if(n===e)return;return s=a.element,n=a.options,n.hide=!a.picker.is(":visible"),a.destroy(),a.picker.remove(),i(a.element).iris(n)}l&&a._dimensions(!0)},_squareDimensions:function(i){var e,t,o=this.controls.square;return i!==r&&o.data("dimensions")?o.data("dimensions"):(t=this.controls.squareDrag,e={w:o.width(),h:o.height()},o.data("dimensions",e),e)},_isNonHueControl:function(i,r){return"square"===i&&"h"===this.options.controls.strip?!0:"external"===r||"h"===r&&"strip"===i?!1:!0},_change:function(){var r=this,e=r.controls,t=r._getHSpaceColor(),o=["square","strip"],s=r.options.controls,a=s[r.active]||"external",n=r.hue;"strip"===r.active?o=[]:"external"!==r.active&&o.pop(),i.each(o,function(i,o){var a,n,l;if(o!==r.active)switch(o){case"strip":a="h"===s.strip?r._scale[s.strip]-t[s.strip]:t[s.strip],e.stripSlider.slider("value",a);break;case"square":n=r._squareDimensions(),l={left:t[s.horiz]/r._scale[s.horiz]*n.w,top:n.h-t[s.vert]/r._scale[s.vert]*n.h},r.controls.squareDrag.css(l)}}),t.h!==n&&r._isNonHueControl(r.active,a)&&r._color.h(n),r.hue=r._color.h(),r.options.color=r._color.toString(),r._inited&&r._trigger("change",{type:r.active},{color:r._color}),r.element.is(":input")&&!r._color.error&&(r.element.removeClass("iris-error"),r.element.val()!==r._color.toString()&&r.element.val(r._color.toString())),r._paint(),r._inited=!0,r.active=!1},_debounce:function(i,r,e){var t,o;return function(){var s,a,n=this,l=arguments;return s=function(){t=null,e||(o=i.apply(n,l))},a=e&&!t,clearTimeout(t),t=setTimeout(s,r),a&&(o=i.apply(n,l)),o}},show:function(){this.picker.show()},hide:function(){this.picker.hide()},toggle:function(){this.picker.toggle()},color:function(i){return i===!0?this._color.clone():i===r?this._color.toString():void this.option("color",i)}},i.widget("a8c.iris",u),void i('<style id="iris-css">'+h+"</style>").appendTo("head"))}(jQuery);